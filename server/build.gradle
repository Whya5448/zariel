plugins {
    id 'org.beryx.jlink' version '2.4.4'
    id "org.javamodularity.moduleplugin" version "1.4.0"
    id 'org.jetbrains.kotlin.jvm' version '1.3.20'
}

dependencies {
    compile project(':library')
    implementation 'com.google.apis:google-api-services-compute:v1-rev199-1.25.0'
    implementation 'commons-io:commons-io:2.6'
    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk8"
}

def sImageName = 'dc-eso-server'
def sModuleName = 'org.metalscraps.eso.lang.server'
def sMainClass = 'org.metalscraps.eso.lang.server.ServerMain'
mainClassName = "${sModuleName}/${sMainClass}"
jar.manifest { attributes 'Implementation-Title': sModuleName, 'Main-Class': sMainClass }

jlink {
    mergedModuleName = "${sModuleName}.merged"
    imageName = sImageName
    options = ['--strip-debug', '--compress', '2', '--no-header-files', '--no-man-pages']
    imageZip = file("$buildDir/${sImageName}-${version}.zip")
    targetPlatform('linux-x64', 'C:/Program Files/Zulu/zulu11.29.3-ca-jdk11.0.2-linux_x64')
    launcher {
        name = 'launch'
        jvmArgs = ['-Xmx2G', '-Dlogback.configurationFile=./logback.xml']
    }
    mergedModule {
        requires 'java.management'
        requires 'java.naming'
        requires 'java.logging'
        requires 'java.sql'
        requires 'java.xml'
        requires 'java.desktop'
        requires 'java.security.jgss'
        requires 'jdk.unsupported'
        uses 'java.nio.file.spi.FileSystemProvider'
        provides 'com.fasterxml.jackson.core.JsonFactory' with 'com.fasterxml.jackson.core.JsonFactory'
        provides 'com.fasterxml.jackson.core.ObjectCodec' with 'com.fasterxml.jackson.databind.ObjectMapper'
    }
}

tasks.jlink.doLast {
    copy {
        from('src/main/resources')
        into("$buildDir/${sImageName}/bin")
    }
}
repositories {
    mavenCentral()
}
compileKotlin {
    kotlinOptions {
        jvmTarget = "1.8"
    }
}
compileTestKotlin {
    kotlinOptions {
        jvmTarget = "1.8"
    }
}

